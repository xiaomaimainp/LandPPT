{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½®ç®¡ç† - LandPPT{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px;">âš™ï¸ ç³»ç»Ÿé…ç½®ç®¡ç†</h2>
    <p style="font-size: 1.1em; color: #7f8c8d;">
        é…ç½®å’Œç®¡ç† LandPPT çš„æ‰€æœ‰ç³»ç»Ÿå‚æ•°ï¼ŒåŒ…æ‹¬ AI æä¾›è€…ã€ç”Ÿæˆå‚æ•°ã€åº”ç”¨é…ç½®ç­‰
    </p>
</div>

<!-- é…ç½®å¯¼èˆªæ ‡ç­¾ -->
<div style="margin-bottom: 30px;">
    <div class="config-tabs" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <button class="tab-btn active" onclick="switchTab('ai-providers')" data-tab="ai-providers">
            ğŸ¤– AI æä¾›è€…
        </button>
        <button class="tab-btn" onclick="switchTab('generation-params')" data-tab="generation-params">
            ğŸ›ï¸ ç”Ÿæˆå‚æ•°
        </button>
        <button class="tab-btn" onclick="switchTab('app-config')" data-tab="app-config">
            ğŸ”§ åº”ç”¨é…ç½®
        </button>
        <button class="tab-btn" onclick="switchTab('image-service')" data-tab="image-service">
            ğŸ¨ å›¾ç‰‡æœåŠ¡
        </button>
    </div>
</div>

<!-- AI æä¾›è€…é…ç½®æ ‡ç­¾é¡µ -->
<div id="ai-providers" class="tab-content active">
    <div class="grid">
        <div class="card">
            <h3 style="color: #3498db; margin-bottom: 15px;">ğŸ“Š å½“å‰çŠ¶æ€</h3>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin-bottom: 10px;">
                    <strong>å½“å‰æä¾›è€…:</strong>
                    <span style="background: #3498db; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9em;">
                        {{ current_provider }}
                    </span>
                </p>
                <p style="margin-bottom: 10px;">
                    <strong>å¯ç”¨æä¾›è€…:</strong> {{ available_providers | length }} ä¸ª
                </p>
                <p>
                    <strong>çŠ¶æ€:</strong>
                    {% if current_provider in available_providers %}
                        <span style="color: #27ae60;">âœ… æ­£å¸¸è¿è¡Œ</span>
                    {% else %}
                        <span style="color: #e74c3c;">âŒ é…ç½®é”™è¯¯</span>
                    {% endif %}
                </p>
            </div>

            <div style="text-align: center;">
                <button onclick="testCurrentProvider()" class="btn btn-primary" style="margin-right: 10px;">
                    ğŸ§ª æµ‹è¯•å½“å‰æä¾›è€…
                </button>
                <button onclick="refreshProviders()" class="btn btn-primary">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
            </div>
        </div>

        
    </div>

    <div style="margin-top: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">ğŸ”§ AI æä¾›è€…è¯¦æƒ…é…ç½®</h3>

        <div class="grid">
            {% for provider in ["openai", "anthropic", "google", "azure_openai", "ollama"] %}
            <div class="card provider-config-card" data-provider="{{ provider }}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #2c3e50; margin: 0;">
                        {% if provider == "openai" %}
                            ğŸ¤– OpenAI
                        {% elif provider == "anthropic" %}
                            ğŸ§  Anthropic Claude
                        {% elif provider == "google" %}
                            ğŸŒŸ Google Gemini
                        {% elif provider == "azure_openai" %}
                            â˜ï¸ Azure OpenAI
                        {% elif provider == "ollama" %}
                            ğŸ  Ollama (æœ¬åœ°)
                        {% endif %}
                    </h4>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        {% if provider_status[provider] %}
                            <span style="background: #27ae60; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                âœ… å¯ç”¨
                            </span>
                        {% else %}
                            <span style="background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em;">
                                âŒ ä¸å¯ç”¨
                            </span>
                        {% endif %}

                        <div class="custom-radio">
                            <input type="radio" name="default_provider" value="{{ provider }}" id="provider_{{ provider }}"
                                   {% if current_provider == provider %}checked{% endif %}
                                   onchange="setDefaultProvider('{{ provider }}')">
                            <label for="provider_{{ provider }}" class="radio-label">é»˜è®¤</label>
                        </div>
                    </div>
                </div>

                <!-- æä¾›è€…é…ç½®è¡¨å• -->
                <div class="provider-config-form">
                    {% if provider == "openai" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="openai_api_key" placeholder="sk-..."
                                   style="font-family: monospace; font-size: 0.9em;">
                        </div>
                        <div class="form-group">
                            <label>Base URL:</label>
                            <input type="text" name="openai_base_url"
                                   value="{{ current_config.get('openai_base_url', '') }}"
                                   placeholder="{{ current_config.get('openai_base_url', 'https://api.openai.com/v1') }}">
                        </div>
                        <div class="form-group">
                            <label>é»˜è®¤æ¨¡å‹:</label>
                            <div class="model-input-container">
                                <select name="openai_model" id="openai_model_select" class="model-select" style="display: none;">
                                    <option value="">é€‰æ‹©æ¨¡å‹...</option>
                                </select>
                                <input type="text" name="openai_model" id="openai_model_input" class="model-input"
                                       value="{{ current_config.get('openai_model', '') }}"
                                       placeholder="{{ current_config.get('openai_model', 'gpt-4o') }}">
                                <button type="button" onclick="fetchAndShowModels()" id="openai_model_fetch_btn"
                                        class="model-fetch-btn" title="è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨">
                                    ğŸ“‹
                                </button>
                            </div>
                            <small style="color: #7f8c8d;">ç›´æ¥è¾“å…¥æ¨¡å‹åç§°ï¼Œæˆ–ç‚¹å‡»å³ä¾§å›¾æ ‡ä»APIè·å–å¯ç”¨æ¨¡å‹</small>
                        </div>
                    {% elif provider == "anthropic" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="anthropic_api_key" placeholder="sk-ant-..."
                                   style="font-family: monospace; font-size: 0.9em;">
                        </div>
                        <div class="form-group">
                            <label>é»˜è®¤æ¨¡å‹:</label>
                            <input type="text" name="anthropic_model"
                                   value="{{ current_config.get('anthropic_model', '') }}"
                                   placeholder="{{ current_config.get('anthropic_model', 'claude-3-5-sonnet-20241022') }}">
                            <small style="color: #7f8c8d;">ç›´æ¥è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ï¼šclaude-3-5-sonnet-20241022, claude-3-opus-20240229</small>
                        </div>
                    {% elif provider == "google" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="google_api_key" placeholder="your-google-api-key"
                                   style="font-family: monospace; font-size: 0.9em;">
                        </div>
                        <div class="form-group">
                            <label>é»˜è®¤æ¨¡å‹:</label>
                            <input type="text" name="google_model"
                                   value="{{ current_config.get('google_model', '') }}"
                                   placeholder="{{ current_config.get('google_model', 'gemini-1.5-flash') }}">
                            <small style="color: #7f8c8d;">ç›´æ¥è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ï¼šgemini-1.5-flash, gemini-1.5-pro, gemini-1.0-pro</small>
                        </div>
                    {% elif provider == "azure_openai" %}
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="password" name="azure_openai_api_key" placeholder="your-azure-key"
                                   style="font-family: monospace; font-size: 0.9em;">
                        </div>
                        <div class="form-group">
                            <label>Endpoint:</label>
                            <input type="text" name="azure_openai_endpoint"
                                   placeholder="https://your-resource.openai.azure.com/">
                        </div>
                        <div class="form-group">
                            <label>Deployment Name:</label>
                            <input type="text" name="azure_openai_deployment_name"
                                   placeholder="your-deployment-name">
                        </div>
                        <div class="form-group">
                            <label>API Version:</label>
                            <input type="text" name="azure_openai_api_version"
                                   placeholder="2024-02-15-preview">
                        </div>
                    {% elif provider == "ollama" %}
                        <div class="form-group">
                            <label>Base URL:</label>
                            <input type="text" name="ollama_base_url"
                                   value="{{ current_config.get('ollama_base_url', '') }}"
                                   placeholder="{{ current_config.get('ollama_base_url', 'http://localhost:11434') }}">
                        </div>
                        <div class="form-group">
                            <label>é»˜è®¤æ¨¡å‹:</label>
                            <input type="text" name="ollama_model"
                                   value="{{ current_config.get('ollama_model', '') }}"
                                   placeholder="{{ current_config.get('ollama_model', 'llama2, mistral, codellama...') }}">
                        </div>
                    {% endif %}
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="testProvider('{{ provider }}')" class="btn btn-primary" style="margin-right: 10px;">
                        ğŸ§ª æµ‹è¯•
                    </button>
                    <button onclick="saveProviderConfig('{{ provider }}')" class="btn btn-success">
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ç”Ÿæˆå‚æ•°é…ç½®æ ‡ç­¾é¡µ -->
<div id="generation-params" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #f39c12; margin-bottom: 20px;">ğŸ›ï¸ AI ç”Ÿæˆå‚æ•°é…ç½®</h3>

        <div class="grid">
            <div>
                <div class="form-group">
                    <label>æœ€å¤§ä»¤ç‰Œæ•° (MAX_TOKENS):</label>
                    <input type="number" name="max_tokens" min="100" max="32000"
                           value="{{ current_config.get('max_tokens', '') }}"
                           placeholder="{{ current_config.get('max_tokens', '2000') }}">
                    <small style="color: #7f8c8d;">æ§åˆ¶ç”Ÿæˆå†…å®¹çš„æœ€å¤§é•¿åº¦</small>
                </div>

                <div class="form-group">
                    <label>æ¸©åº¦ (TEMPERATURE):</label>
                    <input type="number" name="temperature" min="0" max="2" step="0.1"
                           value="{{ current_config.get('temperature', '') }}"
                           placeholder="{{ current_config.get('temperature', '0.7') }}">
                    <small style="color: #7f8c8d;">æ§åˆ¶ç”Ÿæˆå†…å®¹çš„åˆ›é€ æ€§ï¼Œ0=ç¡®å®šæ€§ï¼Œ1=åˆ›é€ æ€§</small>
                </div>

                <div class="form-group">
                    <label>Top-P (TOP_P):</label>
                    <input type="number" name="top_p" min="0" max="1" step="0.1"
                           value="{{ current_config.get('top_p', '') }}"
                           placeholder="{{ current_config.get('top_p', '1.0') }}">
                    <small style="color: #7f8c8d;">æ ¸é‡‡æ ·å‚æ•°ï¼Œæ§åˆ¶è¯æ±‡é€‰æ‹©èŒƒå›´</small>
                </div>
            </div>

            <div>
                <!-- Research Configuration Section -->
                <h4 style="color: #e74c3c; margin-bottom: 15px; margin-top: 25px;">ğŸ” ç ”ç©¶åŠŸèƒ½é…ç½®</h4>

                <div class="form-group">
                    <label>ç ”ç©¶æä¾›å•† (RESEARCH_PROVIDER):</label>
                    <select name="research_provider">
                        <option value="tavily">Tavily (æ¨è)</option>
                        <option value="searxng">SearXNG</option>
                        <option value="both">ä¸¤è€…éƒ½ä½¿ç”¨</option>
                    </select>
                    <small style="color: #7f8c8d;">é€‰æ‹©ç”¨äºç ”ç©¶çš„æœç´¢æä¾›å•†</small>
                </div>

                <div class="form-group">
                    <label>Tavily API Key (ç ”ç©¶åŠŸèƒ½):</label>
                    <input type="password" name="tavily_api_key" placeholder="tvly-..."
                           style="font-family: monospace; font-size: 0.9em;">
                    <small style="color: #7f8c8d;">ç”¨äºæ·±åº¦ç ”ç©¶åŠŸèƒ½çš„APIå¯†é’¥</small>
                </div>

                <div class="form-group">
                    <label>SearXNG ä¸»æœºåœ°å€ (SEARXNG_HOST):</label>
                    <input type="url" name="searxng_host" placeholder="http://localhost:8888"
                           style="font-family: monospace; font-size: 0.9em;">
                    <small style="color: #7f8c8d;">SearXNG å®ä¾‹çš„å®Œæ•´URLåœ°å€</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="research_enable_content_extraction">
                        å¯ç”¨æ·±åº¦å†…å®¹æå– (RESEARCH_ENABLE_CONTENT_EXTRACTION)
                    </label>
                    <small style="color: #7f8c8d;">ä»æœç´¢ç»“æœé¡µé¢æå–å®Œæ•´å†…å®¹è¿›è¡Œæ·±åº¦åˆ†æ</small>
                </div>

                <div class="form-group">
                    <label>æœ€å¤§å†…å®¹é•¿åº¦ (RESEARCH_MAX_CONTENT_LENGTH):</label>
                    <input type="number" name="research_max_content_length" min="1000" max="20000"
                           value="{{ current_config.get('research_max_content_length', '') }}"
                           placeholder="{{ current_config.get('research_max_content_length', '5000') }}">
                    <small style="color: #7f8c8d;">æ¯ä¸ªé¡µé¢æå–çš„æœ€å¤§å­—ç¬¦æ•°</small>
                </div>

                <h4 style="color: #9b59b6; margin-bottom: 15px; margin-top: 25px;">ğŸ“„ å…¶ä»–é…ç½®</h4>

                <div class="form-group">
                    <label>Apryse License Key (PPTå¯¼å‡º):</label>
                    <input type="password" name="apryse_license_key" placeholder="your-apryse-license-key"
                           style="font-family: monospace; font-size: 0.9em;">
                    <small style="color: #7f8c8d;">ç”¨äºPPTXå¯¼å‡ºåŠŸèƒ½çš„Apryse SDKè®¸å¯è¯å¯†é’¥</small>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="saveGenerationParams()" class="btn btn-success">
                ğŸ’¾ ä¿å­˜ç”Ÿæˆå‚æ•°
            </button>
        </div>
    </div>
</div>



<!-- åº”ç”¨é…ç½®æ ‡ç­¾é¡µ -->
<div id="app-config" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #9b59b6; margin-bottom: 20px;">ğŸ”§ åº”ç”¨é…ç½®</h3>

        <div class="grid">
            <div>
                <h4 style="color: #3498db; margin-bottom: 15px;">æœåŠ¡å™¨é…ç½®</h4>

                <div class="form-group">
                    <label>ä¸»æœºåœ°å€ (HOST):</label>
                    <input type="text" name="host" placeholder="0.0.0.0">
                </div>

                <div class="form-group">
                    <label>ç«¯å£ (PORT):</label>
                    <input type="number" name="port" min="1" max="65535" placeholder="8000">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="reload">
                        è‡ªåŠ¨é‡è½½ (RELOAD)
                    </label>
                </div>
            </div>

            <div>
                <h4 style="color: #27ae60; margin-bottom: 15px;">å®‰å…¨é…ç½®</h4>

                <div class="form-group">
                    <label>å¯†é’¥ (SECRET_KEY):</label>
                    <input type="password" name="secret_key" placeholder="your-very-secure-secret-key"
                           style="font-family: monospace; font-size: 0.9em;">
                    <small style="color: #7f8c8d;">ç”¨äºä¼šè¯åŠ å¯†çš„å¯†é’¥</small>
                </div>

                <div class="form-group">
                    <label>è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´ (ACCESS_TOKEN_EXPIRE_MINUTES):</label>
                    <input type="number" name="access_token_expire_minutes" min="0" max="525600"
                           placeholder="30">
                    <small style="color: #7f8c8d;">å•ä½ï¼šåˆ†é’Ÿï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ</small>
                </div>
            </div>

            <div>
                <h4 style="color: #f39c12; margin-bottom: 15px;">æ–‡ä»¶ä¸Šä¼ é…ç½®</h4>

                <div class="form-group">
                    <label>æœ€å¤§æ–‡ä»¶å¤§å° (MAX_FILE_SIZE):</label>
                    <input type="number" name="max_file_size" min="1048576" max="104857600"
                           placeholder="10485760">
                    <small style="color: #7f8c8d;">å•ä½ï¼šå­—èŠ‚ (10MB = 10485760)</small>
                </div>

                <div class="form-group">
                    <label>ä¸Šä¼ ç›®å½• (UPLOAD_DIR):</label>
                    <input type="text" name="upload_dir" placeholder="uploads">
                </div>

                <div class="form-group">
                    <label>ç¼“å­˜TTL (CACHE_TTL):</label>
                    <input type="number" name="cache_ttl" min="60" max="86400"
                           placeholder="3600">
                    <small style="color: #7f8c8d;">å•ä½ï¼šç§’ (1å°æ—¶ = 3600)</small>
                </div>
            </div>

            <div>
                <h4 style="color: #e74c3c; margin-bottom: 15px;">æ•°æ®åº“é…ç½®</h4>

                <div class="form-group">
                    <label>æ•°æ®åº“URL (DATABASE_URL):</label>
                    <input type="text" name="database_url"
                           placeholder="sqlite:///./landppt.db">
                    <small style="color: #7f8c8d;">æ”¯æŒSQLiteã€PostgreSQLã€MySQLç­‰</small>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="saveAppConfig()" class="btn btn-success" style="margin-right: 10px;">
                ğŸ’¾ ä¿å­˜åº”ç”¨é…ç½®
            </button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡æœåŠ¡é…ç½®æ ‡ç­¾é¡µ -->
<div id="image-service" class="tab-content" style="display: none;">
    <div class="card">
        <h3 style="color: #e67e22; margin-bottom: 20px;">ğŸ¨ å›¾ç‰‡æœåŠ¡é…ç½®</h3>

        <!-- æœåŠ¡çŠ¶æ€æ˜¾ç¤º -->
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #dee2e6;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <h4 style="color: #495057; margin: 0; font-size: 1.1em;">ğŸ“Š æœåŠ¡çŠ¶æ€</h4>
                <span id="image-service-status" style="background: #95a5a6; color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.85em; font-weight: 500;">
                    æ£€æŸ¥ä¸­...
                </span>
            </div>
            <div style="color: #6c757d; font-size: 0.9em; line-height: 1.5;">
                <strong>å¯ç”¨æä¾›è€…:</strong> <span id="available-image-providers">æ£€æŸ¥ä¸­...</span>
                <br>
                <span style="color: #868e96;">å›¾ç‰‡æœåŠ¡ä¸ºPPTç”Ÿæˆæä¾›è§†è§‰å†…å®¹æ”¯æŒï¼ŒåŒ…æ‹¬AIå›¾ç‰‡ç”Ÿæˆã€ç½‘ç»œå›¾ç‰‡æœç´¢å’Œæœ¬åœ°å›¾ç‰‡ç®¡ç†</span>
            </div>
        </div>

        <!-- ä¸»è¦é…ç½®åŒºåŸŸ -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 25px;">

            <!-- åŸºç¡€è®¾ç½® -->
            <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #28a745; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ¨</span> å›¾ç‰‡æœåŠ¡è®¾ç½®
                </h4>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 12px; font-weight: 500; color: #495057;">
                        <input type="checkbox" name="enable_image_service" onchange="toggleImageServiceOptions()" style="transform: scale(1.2);">
                        å¯ç”¨å›¾ç‰‡ç”ŸæˆæœåŠ¡
                    </label>
                    <small style="color: #6c757d; margin-top: 8px; display: block;">åœ¨PPTç”Ÿæˆæ—¶è‡ªåŠ¨æ·»åŠ ç›¸å…³å›¾ç‰‡ï¼Œæå‡è§†è§‰æ•ˆæœ</small>
                </div>

                <div id="image-service-options" style="display: none;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h5 style="color: #495057; margin-bottom: 15px; font-weight: 600;">å›¾ç‰‡è·å–æ–¹å¼ (å¯å¤šé€‰)</h5>
                        <div style="display: grid; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_local_images" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">ğŸ“ æœ¬åœ°å›¾åºŠ</div>
                                    <small style="color: #6c757d;">ä»æœ¬åœ°å›¾ç‰‡åº“ä¸­æ™ºèƒ½é€‰æ‹©åˆé€‚çš„å›¾ç‰‡</small>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_network_search" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">ğŸŒ ç½‘ç»œæœç´¢</div>
                                    <small style="color: #6c757d;">é€šè¿‡Unsplashã€Pixabayç­‰APIæœç´¢é«˜è´¨é‡ç½‘ç»œå›¾ç‰‡</small>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="toggleImageSourceConfig()">
                                <input type="checkbox" name="enable_ai_generation" value="true" style="transform: scale(1.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #495057;">ğŸ¨ AIç”Ÿæˆ</div>
                                    <small style="color: #6c757d;">ä½¿ç”¨AIæ¨¡å‹ç”Ÿæˆå®šåˆ¶åŒ–åˆ›æ„å›¾ç‰‡</small>
                                </div>
                            </label>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 6px; border-left: 3px solid #007bff;">
                            <small style="color: #0056b3; font-weight: 500;">ğŸ’¡ æç¤ºï¼šå¯ä»¥åŒæ—¶å¯ç”¨å¤šç§æ–¹å¼ï¼ŒAIä¼šæ ¹æ®é¡µé¢å†…å®¹æ™ºèƒ½é€‰æ‹©æœ€åˆé€‚çš„å›¾ç‰‡æ¥æº</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APIå¯†é’¥é…ç½® -->
            <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #007bff; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>ğŸ”‘</span> APIå¯†é’¥é…ç½®
                </h4>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label style="font-weight: 500; color: #495057;">DALL-E API Key (OpenAI):</label>
                        <input type="password" name="openai_api_key_image" placeholder="sk-..." style="font-family: monospace; font-size: 0.9em; margin-top: 5px;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">ç”¨äºDALL-E 3å›¾ç‰‡ç”Ÿæˆï¼Œä¸æ–‡æœ¬ç”Ÿæˆå…±ç”¨OpenAIå¯†é’¥</small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 500; color: #495057;">SiliconFlow API Key:</label>
                        <input type="password" name="siliconflow_api_key" placeholder="your-siliconflow-api-key" style="font-family: monospace; font-size: 0.9em; margin-top: 5px;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">ç”¨äºSiliconFlow Kolorså›¾ç‰‡ç”Ÿæˆ</small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 500; color: #495057;">Unsplash Access Key:</label>
                        <input type="password" name="unsplash_access_key" placeholder="your-unsplash-access-key" style="font-family: monospace; font-size: 0.9em; margin-top: 5px;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">ç”¨äºæœç´¢Unsplashé«˜è´¨é‡æ‘„å½±å›¾ç‰‡ï¼Œæ”¯æŒå¤šè¯­è¨€æœç´¢</small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 500; color: #495057;">Pixabay API Key:</label>
                        <input type="password" name="pixabay_api_key" placeholder="your-pixabay-api-key" style="font-family: monospace; font-size: 0.9em; margin-top: 5px;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">ç”¨äºæœç´¢å…è´¹å›¾ç‰‡å’Œæ’å›¾</small>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 500; color: #495057;">SearXNG Host:</label>
                        <input type="url" name="searxng_host" placeholder="http://localhost:8888" style="font-family: monospace; font-size: 0.9em; margin-top: 5px;">
                        <small style="color: #6c757d; margin-top: 5px; display: block;">SearXNGå®ä¾‹çš„ä¸»æœºåœ°å€ï¼Œç”¨äºå¼€æºæœç´¢å¼•æ“å›¾ç‰‡æœç´¢</small>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†é…ç½® -->
            <div style="background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="color: #6f42c1; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                    <span>âš™ï¸</span> è¯¦ç»†é…ç½®
                </h4>

                    <!-- æœ¬åœ°å›¾åºŠé…ç½® -->
                    <div id="local-images-config" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h5 style="color: #27ae60; margin-bottom: 10px;">ğŸ“ æœ¬åœ°å›¾åºŠé…ç½®</h5>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" name="local_images_smart_selection" checked>
                                å¯ç”¨æ™ºèƒ½é€‰æ‹©
                            </label>
                            <small style="color: #7f8c8d;">AIä¼šæ ¹æ®å†…å®¹æ™ºèƒ½åŒ¹é…æœ¬åœ°å›¾ç‰‡åº“ä¸­çš„å›¾ç‰‡</small>
                        </div>
                        <div class="form-group">
                            <label>æ¯é¡µæœ€å¤§æœ¬åœ°å›¾ç‰‡æ•°é‡:</label>
                            <input type="number" name="max_local_images_per_slide" value="2" min="1" max="5">
                            <small style="color: #7f8c8d;">é™åˆ¶æ¯é¡µä»æœ¬åœ°å›¾åºŠé€‰æ‹©çš„å›¾ç‰‡æ•°é‡</small>
                        </div>
                    </div>

                    <!-- ç½‘ç»œæœç´¢é…ç½® -->
                    <div id="network-search-config" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h5 style="color: #3498db; margin-bottom: 10px;">ğŸŒ ç½‘ç»œæœç´¢é…ç½®</h5>
                        <div class="form-group">
                            <label>é»˜è®¤ç½‘ç»œæœç´¢æä¾›å•†:</label>
                            <select name="default_network_search_provider">
                                <option value="unsplash">Unsplash (é«˜è´¨é‡æ‘„å½±å›¾ç‰‡)</option>
                                <option value="pixabay" selected>Pixabay (å…è´¹å›¾ç‰‡å’Œæ’å›¾)</option>
                                <option value="searxng">SearXNG (å¼€æºæœç´¢å¼•æ“)</option>
                            </select>
                            <small style="color: #7f8c8d;">é€‰æ‹©ä¼˜å…ˆä½¿ç”¨çš„ç½‘ç»œæœç´¢æº</small>
                        </div>
                        <div class="form-group">
                            <label>æ¯é¡µæœ€å¤§ç½‘ç»œå›¾ç‰‡æ•°é‡:</label>
                            <input type="number" name="max_network_images_per_slide" value="2" min="1" max="5">
                            <small style="color: #7f8c8d;">é™åˆ¶æ¯é¡µä»ç½‘ç»œæœç´¢çš„å›¾ç‰‡æ•°é‡</small>
                        </div>
                    </div>

                    <!-- AIç”Ÿæˆé…ç½® -->
                    <div id="ai-generation-config" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h5 style="color: #9b59b6; margin-bottom: 10px;">ğŸ¨ AIç”Ÿæˆé…ç½®</h5>
                        <div class="form-group">
                            <label>é»˜è®¤AIå›¾ç‰‡ç”Ÿæˆæä¾›å•†:</label>
                            <select name="default_ai_image_provider">
                                <option value="dalle">DALL-E 3 (OpenAI)</option>
                                <option value="siliconflow">SiliconFlow (Kolors)</option>
                            </select>
                            <small style="color: #7f8c8d;">é€‰æ‹©é»˜è®¤çš„AIå›¾ç‰‡ç”ŸæˆæœåŠ¡</small>
                        </div>
                        <div class="form-group">
                            <label>æ¯é¡µæœ€å¤§AIç”Ÿæˆå›¾ç‰‡æ•°é‡:</label>
                            <input type="number" name="max_ai_images_per_slide" value="1" min="1" max="3">
                            <small style="color: #7f8c8d;">é™åˆ¶æ¯é¡µAIç”Ÿæˆçš„å›¾ç‰‡æ•°é‡</small>
                        </div>
                        <div class="form-group">
                            <label>å›¾ç‰‡ç”Ÿæˆè´¨é‡:</label>
                            <select name="ai_image_quality">
                                <option value="standard">æ ‡å‡†è´¨é‡</option>
                                <option value="hd">é«˜æ¸…è´¨é‡</option>
                            </select>
                            <small style="color: #7f8c8d;">æ›´é«˜è´¨é‡çš„å›¾ç‰‡éœ€è¦æ›´å¤šæ—¶é—´å’Œæˆæœ¬</small>
                        </div>
                    </div>

                    <!-- å…¨å±€å›¾ç‰‡é…ç½® -->
                    <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h5 style="color: #856404; margin-bottom: 15px; font-weight: 600;">âš™ï¸ å…¨å±€å›¾ç‰‡é…ç½®</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="font-weight: 500; color: #495057;">æ¯é¡µæœ€å¤§å›¾ç‰‡æ€»æ•°:</label>
                                <input type="number" name="max_total_images_per_slide" value="3" min="1" max="8" style="margin-top: 5px;">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">é™åˆ¶æ¯é¡µå›¾ç‰‡çš„æ€»æ•°é‡ï¼Œé¿å…é¡µé¢è¿‡äºæ‹¥æŒ¤</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #495057;">
                                    <input type="checkbox" name="enable_smart_image_selection" checked style="transform: scale(1.1);">
                                    å¯ç”¨æ™ºèƒ½å›¾ç‰‡é€‰æ‹©
                                </label>
                                <small style="color: #6c757d; margin-top: 8px; display: block;">AIä¼šæ ¹æ®é¡µé¢å†…å®¹å’Œè®¾è®¡éœ€æ±‚æ™ºèƒ½å†³å®šå›¾ç‰‡æ•°é‡å’Œæ¥æº</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="text-align: center; margin-top: 35px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;">
            <button onclick="saveImageServiceConfig()" class="btn btn-success" style="padding: 10px 20px; font-weight: 500;">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </div>
    </div>
</div>



<!-- Test Results Modal -->
<div id="testModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">
            ğŸ§ª AI æä¾›è€…æµ‹è¯•ç»“æœ
        </h3>
        
        <div id="testResults" style="margin-bottom: 20px;">
            <!-- Test results will be inserted here -->
        </div>
        
        <div style="text-align: center;">
            <button onclick="closeTestModal()" class="btn" style="background: #95a5a6;">å…³é—­</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* é…ç½®æ ‡ç­¾é¡µæ ·å¼ */
.config-tabs {
    border-bottom: 2px solid var(--glass-border);
    margin-bottom: 30px;
}

.tab-btn {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
    padding: 12px 24px;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    margin-bottom: -2px;
    position: relative;
}

.tab-btn:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
}

.tab-btn.active {
    background: var(--primary-gradient);
    color: white;
    border-bottom: 2px solid transparent;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.tab-content {
    animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
    display: block !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* æä¾›è€…é…ç½®å¡ç‰‡æ ·å¼ */
.provider-config-card {
    transition: all 0.3s ease;
}

.provider-config-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
}

.provider-config-form .form-group {
    margin-bottom: 15px;
}

.provider-config-form .form-group label {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 5px;
}

.provider-config-form .form-group input,
.provider-config-form .form-group select {
    padding: 10px 15px;
    font-size: 0.9rem;
}

.provider-config-form .form-group small {
    display: block;
    margin-top: 5px;
    font-size: 0.8rem;
    line-height: 1.4;
}



/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-available {
    background: #27ae60;
    color: white;
}

.status-unavailable {
    background: #e74c3c;
    color: white;
}

/* ç¾åŒ–çš„å•é€‰æ¡†æ ·å¼ */
.custom-radio {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 10px;
}

.custom-radio input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #ddd;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.custom-radio input[type="radio"]:hover {
    border-color: #667eea;
    transform: scale(1.1);
}

.custom-radio input[type="radio"]:checked {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.custom-radio input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: white;
}

.custom-radio .radio-label {
    font-size: 0.85em;
    color: #7f8c8d;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.3s ease;
}

.custom-radio input[type="radio"]:checked + .radio-label {
    color: #667eea;
}

/* ç¾åŒ–çš„å¤é€‰æ¡†æ ·å¼ */
.form-group input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid #ddd;
    border-radius: 4px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    margin-right: 8px;
}

.form-group input[type="checkbox"]:hover {
    border-color: #667eea;
    transform: scale(1.05);
}

.form-group input[type="checkbox"]:checked {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.form-group input[type="checkbox"]:checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* ç¾åŒ–çš„é€‰æ‹©æ¡†æ ·å¼ */
.form-group select {
    appearance: none;
    -webkit-appearance: none;
    background: white;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.form-group select:hover {
    border-color: #667eea;
}

.form-group select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

/* ç¾åŒ–çš„è¾“å…¥æ¡†æ ·å¼ */
.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group input[type="url"] {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: white;
}

.form-group input[type="text"]:hover,
.form-group input[type="password"]:hover,
.form-group input[type="number"]:hover,
.form-group input[type="url"]:hover {
    border-color: #667eea;
}

.form-group input[type="text"]:focus,
.form-group input[type="password"]:focus,
.form-group input[type="number"]:focus,
.form-group input[type="url"]:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

/* ç¾åŒ–çš„æŒ‰é’®æ ·å¼ */
.btn {
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    color: white;
}

.btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

/* OpenAIæ¨¡å‹è¾“å…¥æ¡†æ ·å¼ */
.model-input-container {
    position: relative;
    display: flex;
    align-items: center;
}

.model-input,
.model-select {
    flex: 1;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 10px 45px 10px 15px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    background: white;
}

.model-input:hover,
.model-select:hover {
    border-color: #667eea;
}

.model-input:focus,
.model-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.model-fetch-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #6c757d;
}

.model-fetch-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.model-fetch-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: translateY(-50%);
}

.model-fetch-btn.loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: translateY(-50%) rotate(0deg); }
    to { transform: translateY(-50%) rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .config-tabs {
        flex-direction: column;
        align-items: stretch;
    }

    .tab-btn {
        border-radius: 8px;
        margin-bottom: 5px;
    }

    .tab-btn.active {
        transform: none;
    }

    .grid {
        grid-template-columns: 1fr;
    }

    .model-fetch-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }


}
</style>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let currentConfig = {};
let availableProviders = ['openai', 'anthropic', 'google', 'azure_openai', 'ollama'];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½åˆå§‹é…ç½®
    loadAllConfigs();
    // æ£€æŸ¥å›¾ç‰‡æœåŠ¡çŠ¶æ€
    checkImageServiceStatus();
});

// æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
function switchTab(tabName) {
    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
    });

    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
    }

    // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
    const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }

    // åŠ è½½å¯¹åº”çš„é…ç½®æ•°æ®
    loadTabConfig(tabName);
}

// åŠ è½½æ ‡ç­¾é¡µé…ç½®æ•°æ®
async function loadTabConfig(tabName) {
    try {
        const categoryMap = {
            'ai-providers': 'ai_providers',
            'generation-params': 'generation_params',
            'app-config': 'app_config',
            'image-service': 'image_service'
        };

        const category = categoryMap[tabName];
        if (!category) return;

        const response = await fetch(`/api/config/${category}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                populateTabForm(tabName, result.config);
            }
        }
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    }
}

// å¡«å……è¡¨å•æ•°æ®
function populateTabForm(tabName, config) {
    const tabElement = document.getElementById(tabName);
    if (!tabElement) return;

    // å¡«å……è¾“å…¥æ¡†
    tabElement.querySelectorAll('input, select, textarea').forEach(input => {
        const name = input.name;
        if (config[name] !== undefined) {
            if (input.type === 'checkbox') {
                input.checked = config[name];
            } else {
                input.value = config[name];
            }
        }
    });

    // å¦‚æœæ˜¯å›¾ç‰‡æœåŠ¡æ ‡ç­¾é¡µï¼Œè§¦å‘é€‰é¡¹æ˜¾ç¤ºæ›´æ–°
    if (tabName === 'image-service') {
        setTimeout(() => {
            toggleImageServiceOptions();
        }, 100);
    }
}

// AIæä¾›è€…æµ‹è¯•åŠŸèƒ½
async function testProvider(providerName) {
    showLoading(`æ­£åœ¨æµ‹è¯• ${providerName} æä¾›è€…...`);

    try {
        const response = await fetch(`/api/ai/providers/${providerName}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (response.ok) {
            showTestResult(result, true);
        } else {
            showTestResult(result, false);
        }
    } catch (error) {
        showTestResult({error: error.message}, false);
    }
}

async function testCurrentProvider() {
    await testProvider('{{ current_provider }}');
}

function refreshProviders() {
    window.location.reload();
}

// é…ç½®ç®¡ç†åŠŸèƒ½
async function loadAllConfigs() {
    try {
        const response = await fetch('/api/config/all');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                currentConfig = result.config;
                populateAllForms();
            }
        }
    } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    }
}

function populateAllForms() {
    // å¡«å……AIæä¾›è€…é…ç½®
    populateProviderForms();

    // å¡«å……ç”Ÿæˆå‚æ•°
    populateGenerationParams();

    // å¡«å……åº”ç”¨é…ç½®
    populateAppConfig();

    // å¡«å……å›¾ç‰‡æœåŠ¡é…ç½®
    populateImageServiceConfig();
}

function populateProviderForms() {
    document.querySelectorAll('.provider-config-card').forEach(card => {
        const provider = card.dataset.provider;
        const inputs = card.querySelectorAll('input, select');

        inputs.forEach(input => {
            const configKey = input.name;
            if (currentConfig[configKey]) {
                if (input.type === 'checkbox') {
                    input.checked = currentConfig[configKey] === 'true';
                } else if (input.type === 'password') {
                    // å¯¹äºå¯†ç å­—æ®µï¼Œåªæ›´æ–°placeholderï¼Œä¸è¦†ç›–value
                    if (!input.value) {
                        input.placeholder = currentConfig[configKey] ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : input.placeholder;
                    }
                } else {
                    // åªæœ‰å½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ï¼Œé¿å…è¦†ç›–æ¨¡æ¿ä¸­å·²è®¾ç½®çš„å€¼
                    if (!input.value && currentConfig[configKey]) {
                        input.value = currentConfig[configKey];
                    }
                }
            }
        });
    });
}

function populateGenerationParams() {
    const tab = document.getElementById('generation-params');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey]) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true';
            } else if (input.type === 'password') {
                // å¯¹äºå¯†ç å­—æ®µï¼Œåªæ›´æ–°placeholderï¼Œä¸è¦†ç›–value
                if (!input.value) {
                    input.placeholder = currentConfig[configKey] ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : input.placeholder;
                }
            } else {
                // åªæœ‰å½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ï¼Œé¿å…è¦†ç›–æ¨¡æ¿ä¸­å·²è®¾ç½®çš„å€¼
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });
}



function populateAppConfig() {
    const tab = document.getElementById('app-config');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey]) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true';
            } else if (input.type === 'password') {
                // å¯¹äºå¯†ç å­—æ®µï¼Œåªæ›´æ–°placeholderï¼Œä¸è¦†ç›–value
                if (!input.value) {
                    input.placeholder = currentConfig[configKey] ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : input.placeholder;
                }
            } else {
                // åªæœ‰å½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ï¼Œé¿å…è¦†ç›–æ¨¡æ¿ä¸­å·²è®¾ç½®çš„å€¼
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });
}

function populateImageServiceConfig() {
    const tab = document.getElementById('image-service');
    if (!tab) return;

    const inputs = tab.querySelectorAll('input, select');
    inputs.forEach(input => {
        const configKey = input.name;
        if (currentConfig[configKey] !== undefined) {
            if (input.type === 'checkbox') {
                input.checked = currentConfig[configKey] === 'true' || currentConfig[configKey] === true;
            } else if (input.type === 'password') {
                // å¯¹äºå¯†ç å­—æ®µï¼Œåªæ›´æ–°placeholderï¼Œä¸è¦†ç›–value
                if (!input.value) {
                    input.placeholder = currentConfig[configKey] ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : input.placeholder;
                }
            } else {
                // åªæœ‰å½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ï¼Œé¿å…è¦†ç›–æ¨¡æ¿ä¸­å·²è®¾ç½®çš„å€¼
                if (!input.value && currentConfig[configKey]) {
                    input.value = currentConfig[configKey];
                }
            }
        }
    });

    // è§¦å‘å›¾ç‰‡æœåŠ¡é€‰é¡¹æ˜¾ç¤ºæ›´æ–°
    setTimeout(() => {
        toggleImageServiceOptions();
    }, 100);
}

// è®¾ç½®é»˜è®¤æä¾›è€…
async function setDefaultProvider(provider) {
    try {
        showLoading('æ­£åœ¨è®¾ç½®é»˜è®¤æä¾›è€…...');

        const response = await fetch('/api/config/default-provider', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ provider: provider })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`é»˜è®¤æä¾›è€…å·²è®¾ç½®ä¸º ${provider}ï¼Œé…ç½®å·²å®æ—¶ç”Ÿæ•ˆ`, 'success');

                // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„å½“å‰æä¾›è€…
                updateCurrentProviderDisplay(provider);

                // å¯é€‰ï¼šåˆ·æ–°æä¾›è€…çŠ¶æ€
                setTimeout(() => {
                    refreshProviders();
                }, 1000);
            } else {
                showNotification('è®¾ç½®é»˜è®¤æä¾›è€…å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } else {
            showNotification('è®¾ç½®é»˜è®¤æä¾›è€…å¤±è´¥', 'error');
        }

        closeTestModal();
    } catch (error) {
        showNotification('è®¾ç½®é»˜è®¤æä¾›è€…å¤±è´¥: ' + error.message, 'error');
        closeTestModal();
    }
}

// æ›´æ–°å½“å‰æä¾›è€…æ˜¾ç¤º
function updateCurrentProviderDisplay(provider) {
    const currentProviderSpan = document.querySelector('.card p span');
    if (currentProviderSpan) {
        currentProviderSpan.textContent = provider;
    }
}

// ä¿å­˜æä¾›è€…é…ç½®
async function saveProviderConfig(provider) {
    const card = document.querySelector(`[data-provider="${provider}"]`);
    if (!card) return;

    const config = {};
    const inputs = card.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name && input.value) {
            // è·³è¿‡ default_provider radio æŒ‰é’®ï¼Œå› ä¸ºå®ƒé€šè¿‡ä¸“é—¨çš„ API å¤„ç†
            if (input.name === 'default_provider') {
                return;
            }
            config[input.name] = input.value;
        }
    });

    try {
        showLoading(`æ­£åœ¨ä¿å­˜ ${provider} é…ç½®...`);

        const response = await fetch('/api/config/ai_providers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification(`${provider} é…ç½®ä¿å­˜æˆåŠŸï¼Œå·²å®æ—¶ç”Ÿæ•ˆ`, 'success');
                // é‡æ–°åŠ è½½é…ç½®
                loadAllConfigs();
            } else {
                showNotification(`${provider} é…ç½®ä¿å­˜å¤±è´¥: ${result.errors || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        } else {
            showNotification(`${provider} é…ç½®ä¿å­˜å¤±è´¥`, 'error');
        }

        closeTestModal();
    } catch (error) {
        showNotification('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
        closeTestModal();
    }
}

// ä¿å­˜ç”Ÿæˆå‚æ•°
async function saveGenerationParams() {
    const tab = document.getElementById('generation-params');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/generation_params', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('ç”Ÿæˆå‚æ•°ä¿å­˜æˆåŠŸï¼Œå·²å®æ—¶ç”Ÿæ•ˆ', 'success');
                // é‡æ–°åŠ è½½é…ç½®
                loadAllConfigs();
            } else {
                showNotification('ç”Ÿæˆå‚æ•°ä¿å­˜å¤±è´¥: ' + (result.errors || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } else {
            showNotification('ç”Ÿæˆå‚æ•°ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
}



// ä¿å­˜åº”ç”¨é…ç½®
async function saveAppConfig() {
    const tab = document.getElementById('app-config');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/app_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('åº”ç”¨é…ç½®ä¿å­˜æˆåŠŸï¼Œå·²å®æ—¶ç”Ÿæ•ˆ', 'success');
                // é‡æ–°åŠ è½½é…ç½®
                loadAllConfigs();
            } else {
                showNotification('åº”ç”¨é…ç½®ä¿å­˜å¤±è´¥: ' + (result.errors || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } else {
            showNotification('åº”ç”¨é…ç½®ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
}

// ä¿å­˜æ‰€æœ‰é…ç½®
async function saveAllConfigs() {
    showLoading('æ­£åœ¨ä¿å­˜æ‰€æœ‰é…ç½®...');

    try {
        // æ”¶é›†æ‰€æœ‰é…ç½®
        const allConfig = {};

        // æ”¶é›†AIæä¾›è€…é…ç½®
        document.querySelectorAll('.provider-config-card').forEach(card => {
            const inputs = card.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    // è·³è¿‡ default_provider radio æŒ‰é’®ï¼Œå› ä¸ºå®ƒé€šè¿‡ä¸“é—¨çš„ API å¤„ç†
                    if (input.name === 'default_provider') {
                        return;
                    }
                    allConfig[input.name] = input.value;
                }
            });
        });

        // æ”¶é›†å…¶ä»–é…ç½®
        ['generation-params', 'app-config'].forEach(tabId => {
            const tab = document.getElementById(tabId);
            if (tab) {
                const inputs = tab.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.name) {
                        if (input.type === 'checkbox') {
                            allConfig[input.name] = input.checked;
                        } else if (input.value) {
                            allConfig[input.name] = input.value;
                        }
                    }
                });
            }
        });

        const response = await fetch('/api/config/all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: allConfig })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('æ‰€æœ‰é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showNotification('é…ç½®ä¿å­˜å¤±è´¥: ' + (result.errors || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
            closeTestModal();
        } else {
            showNotification('é…ç½®ä¿å­˜å¤±è´¥', 'error');
            closeTestModal();
        }
    } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        closeTestModal();
    }
}











// é€šçŸ¥åŠŸèƒ½
function showNotification(message, type = 'info') {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;

    // è®¾ç½®èƒŒæ™¯é¢œè‰²
    switch (type) {
        case 'success':
            notification.style.background = 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)';
            break;
        case 'error':
            notification.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            break;
        case 'warning':
            notification.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            break;
        default:
            notification.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);

    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function showLoading(message) {
    document.getElementById('testResults').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
            <p>${message}</p>
        </div>
    `;
    document.getElementById('testModal').style.display = 'block';
}

function showTestResult(result, success) {
    const statusIcon = success ? 'âœ…' : 'âŒ';
    const statusColor = success ? '#27ae60' : '#e74c3c';
    
    let content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${statusIcon}</div>
            <h4 style="color: ${statusColor};">${success ? 'æµ‹è¯•æˆåŠŸ' : 'æµ‹è¯•å¤±è´¥'}</h4>
        </div>
    `;
    
    if (success) {
        content += `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <p><strong>æä¾›è€…:</strong> ${result.provider}</p>
                <p><strong>æ¨¡å‹:</strong> ${result.model}</p>
                <p><strong>å“åº”é¢„è§ˆ:</strong></p>
                <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; font-size: 0.9em;">
                    ${result.response_preview}
                </div>
                <p style="margin-top: 15px;"><strong>ä½¿ç”¨ç»Ÿè®¡:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>æç¤ºè¯ä»¤ç‰Œ: ${result.usage.prompt_tokens}</li>
                    <li>å®Œæˆä»¤ç‰Œ: ${result.usage.completion_tokens}</li>
                    <li>æ€»ä»¤ç‰Œ: ${result.usage.total_tokens}</li>
                </ul>
            </div>
        `;
    } else {
        content += `
            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <p><strong>é”™è¯¯ä¿¡æ¯:</strong></p>
                <div style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                    ${result.detail || result.error || 'æœªçŸ¥é”™è¯¯'}
                </div>
            </div>
        `;
    }
    
    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';
}

function showAllTestResults(results) {
    let content = '<div style="margin-bottom: 20px;">';
    
    results.forEach(({provider, result, success}) => {
        const statusIcon = success ? 'âœ…' : 'âŒ';
        const statusColor = success ? '#27ae60' : '#e74c3c';
        
        content += `
            <div style="border: 1px solid #ecf0f1; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>${provider}</strong>
                    <span style="color: ${statusColor};">${statusIcon} ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}</span>
                </div>
                ${success ? 
                    `<p style="color: #7f8c8d; font-size: 0.9em;">æ¨¡å‹: ${result.model} | å“åº”: ${result.response_preview.substring(0, 50)}...</p>` :
                    `<p style="color: #e74c3c; font-size: 0.9em;">é”™è¯¯: ${result.detail || result.error}</p>`
                }
            </div>
        `;
    });
    
    content += '</div>';
    
    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';
}

function closeTestModal() {
    document.getElementById('testModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('testModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTestModal();
    }
});

// å›¾ç‰‡æœåŠ¡ç›¸å…³åŠŸèƒ½
async function checkImageServiceStatus() {
    try {
        const response = await fetch('/api/image/status');
        if (response.ok) {
            const result = await response.json();
            updateImageServiceStatus(result);
        } else {
            updateImageServiceStatus({
                status: 'error',
                available_providers: [],
                message: 'æ— æ³•è¿æ¥åˆ°å›¾ç‰‡æœåŠ¡'
            });
        }
    } catch (error) {
        updateImageServiceStatus({
            status: 'error',
            available_providers: [],
            message: 'æ£€æŸ¥å›¾ç‰‡æœåŠ¡çŠ¶æ€å¤±è´¥: ' + error.message
        });
    }
}

function updateImageServiceStatus(status) {
    const statusElement = document.getElementById('image-service-status');
    const providersElement = document.getElementById('available-image-providers');

    if (statusElement) {
        if (status.status === 'ok' && status.available_providers.length > 0) {
            statusElement.textContent = 'âœ… æ­£å¸¸è¿è¡Œ';
            statusElement.style.background = '#27ae60';
        } else {
            statusElement.textContent = 'âŒ æœåŠ¡å¼‚å¸¸';
            statusElement.style.background = '#e74c3c';
        }
    }

    if (providersElement) {
        if (status.available_providers && status.available_providers.length > 0) {
            providersElement.textContent = status.available_providers.join(', ') + ` (${status.available_providers.length}ä¸ª)`;
        } else {
            providersElement.textContent = 'æ— å¯ç”¨æä¾›è€…';
        }
    }
}

function showImageTestResult(result, success) {
    const statusIcon = success ? 'âœ…' : 'âŒ';
    const statusColor = success ? '#27ae60' : '#e74c3c';

    let content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">${statusIcon}</div>
            <h4 style="color: ${statusColor};">${success ? 'å›¾ç‰‡æœåŠ¡æµ‹è¯•æˆåŠŸ' : 'å›¾ç‰‡æœåŠ¡æµ‹è¯•å¤±è´¥'}</h4>
        </div>
    `;

    if (success) {
        content += `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <p><strong>æµ‹è¯•ç»“æœ:</strong></p>
                <ul style="margin-left: 20px;">
        `;

        if (result.providers) {
            Object.entries(result.providers).forEach(([provider, status]) => {
                const icon = status.available ? 'âœ…' : 'âŒ';
                content += `<li>${icon} ${provider}: ${status.message}</li>`;
            });
        }

        content += `
                </ul>
                <p style="margin-top: 15px;"><strong>ç¼“å­˜ä¿¡æ¯:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>ç¼“å­˜ç›®å½•: ${result.cache_info?.directory || 'temp/images_cache'}</li>
                    <li>ç¼“å­˜å¤§å°: ${result.cache_info?.size || '0 MB'}</li>
                    <li>æ–‡ä»¶æ•°é‡: ${result.cache_info?.file_count || 0}</li>
                </ul>
            </div>
        `;
    } else {
        content += `
            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <p><strong>é”™è¯¯ä¿¡æ¯:</strong></p>
                <div style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                    ${result.detail || result.error || 'æœªçŸ¥é”™è¯¯'}
                </div>
            </div>
        `;
    }

    document.getElementById('testResults').innerHTML = content;
    document.getElementById('testModal').style.display = 'block';
}


async function saveImageServiceConfig() {
    const tab = document.getElementById('image-service');
    if (!tab) return;

    const config = {};
    const inputs = tab.querySelectorAll('input, select');

    inputs.forEach(input => {
        if (input.name) {
            if (input.type === 'checkbox') {
                config[input.name] = input.checked;
            } else if (input.value) {
                config[input.name] = input.value;
            }
        }
    });

    try {
        const response = await fetch('/api/config/image_service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ config: config })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showNotification('å›¾ç‰‡æœåŠ¡é…ç½®ä¿å­˜æˆåŠŸï¼Œå·²å®æ—¶ç”Ÿæ•ˆ', 'success');
                // é‡æ–°æ£€æŸ¥å›¾ç‰‡æœåŠ¡çŠ¶æ€
                checkImageServiceStatus();
                // é‡æ–°åŠ è½½é…ç½®
                loadAllConfigs();
            } else {
                showNotification('å›¾ç‰‡æœåŠ¡é…ç½®ä¿å­˜å¤±è´¥: ' + (result.errors || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } else {
            showNotification('å›¾ç‰‡æœåŠ¡é…ç½®ä¿å­˜å¤±è´¥', 'error');
        }
    } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
}

// å›¾ç‰‡æœåŠ¡é€‰é¡¹æ§åˆ¶å‡½æ•°
function toggleImageServiceOptions() {
    const enableCheckbox = document.querySelector('input[name="enable_image_service"]');
    const optionsDiv = document.getElementById('image-service-options');

    if (enableCheckbox && optionsDiv) {
        if (enableCheckbox.checked) {
            optionsDiv.style.display = 'block';
            // è§¦å‘ä¸€æ¬¡é…ç½®æ˜¾ç¤ºæ›´æ–°
            toggleImageSourceConfig();
        } else {
            optionsDiv.style.display = 'none';
        }
    }
}

function toggleImageSourceConfig() {
    const localCheckbox = document.querySelector('input[name="enable_local_images"]');
    const networkCheckbox = document.querySelector('input[name="enable_network_search"]');
    const aiCheckbox = document.querySelector('input[name="enable_ai_generation"]');

    const localConfig = document.getElementById('local-images-config');
    const networkConfig = document.getElementById('network-search-config');
    const aiConfig = document.getElementById('ai-generation-config');

    if (!localConfig || !networkConfig || !aiConfig) return;

    // æ ¹æ®å¤é€‰æ¡†çŠ¶æ€æ˜¾ç¤º/éšè—å¯¹åº”é…ç½®
    if (localCheckbox && localCheckbox.checked) {
        localConfig.style.display = 'block';
    } else {
        localConfig.style.display = 'none';
    }

    if (networkCheckbox && networkCheckbox.checked) {
        networkConfig.style.display = 'block';
    } else {
        networkConfig.style.display = 'none';
    }

    if (aiCheckbox && aiCheckbox.checked) {
        aiConfig.style.display = 'block';
    } else {
        aiConfig.style.display = 'none';
    }
}

// è·å–å¹¶æ˜¾ç¤ºOpenAIæ¨¡å‹åˆ—è¡¨
async function fetchAndShowModels() {
    const selectElement = document.getElementById('openai_model_select');
    const inputElement = document.getElementById('openai_model_input');
    const fetchButton = document.getElementById('openai_model_fetch_btn');

    if (!selectElement || !inputElement || !fetchButton) return;

    try {
        // è®¾ç½®åŠ è½½çŠ¶æ€
        fetchButton.classList.add('loading');
        fetchButton.disabled = true;
        fetchButton.textContent = 'â³';

        // è·å–Base URL
        const baseUrlInput = document.querySelector('input[name="openai_base_url"]');
        let baseUrl = baseUrlInput ? baseUrlInput.value.trim() : '';

        // å¦‚æœæ²¡æœ‰è®¾ç½®Base URLï¼Œä½¿ç”¨é»˜è®¤å€¼
        if (!baseUrl) {
            baseUrl = baseUrlInput ? baseUrlInput.placeholder : 'https://api.openai.com/v1';
        }

        // ç¡®ä¿Base URLä»¥/v1ç»“å°¾
        if (!baseUrl.endsWith('/v1')) {
            if (baseUrl.endsWith('/')) {
                baseUrl += 'v1';
            } else {
                baseUrl += '/v1';
            }
        }

        // è·å–API Keyï¼ˆå‰ç«¯è¾“å…¥æˆ–ä»åç«¯è·å–ï¼‰
        let apiKey = '';
        const apiKeyInput = document.querySelector('input[name="openai_api_key"]');
        if (apiKeyInput && apiKeyInput.value.trim()) {
            apiKey = apiKeyInput.value.trim();
        } else {
            // ä»åç«¯è·å–API Key
            try {
                const configResponse = await fetch('/api/config/ai_providers');
                if (configResponse.ok) {
                    const configResult = await configResponse.json();
                    if (configResult.success && configResult.config.openai_api_key) {
                        apiKey = configResult.config.openai_api_key;
                    }
                }
            } catch (configError) {
                console.warn('æ— æ³•ä»åç«¯è·å–API Key:', configError);
            }
        }

        if (!apiKey) {
            showNotification('è¯·å…ˆé…ç½®API Key', 'warning');
            return;
        }

        // è·å–æ¨¡å‹åˆ—è¡¨
        const models = await fetchOpenAIModels(baseUrl, apiKey);

        if (models && models.length > 0) {
            // å¦‚æœå½“å‰æ˜¯è¾“å…¥æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°é€‰æ‹©æ¨¡å¼
            if (selectElement.style.display === 'none') {
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                selectElement.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';

                // æ·»åŠ æ¨¡å‹é€‰é¡¹
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    selectElement.appendChild(option);
                });

                // ä¿å­˜å½“å‰è¾“å…¥æ¡†çš„å€¼
                const currentValue = inputElement.value;

                // åˆ‡æ¢æ˜¾ç¤º
                inputElement.style.display = 'none';
                selectElement.style.display = 'block';

                // è®¾ç½®é€‰æ‹©æ¡†çš„å€¼
                if (currentValue && selectElement.querySelector(`option[value="${currentValue}"]`)) {
                    selectElement.value = currentValue;
                } else {
                    selectElement.value = ''; // æ˜¾ç¤º"é€‰æ‹©æ¨¡å‹..."
                    inputElement.placeholder = 'é€‰æ‹©æ¨¡å‹...'; // åŒæ—¶æ›´æ–°è¾“å…¥æ¡†çš„placeholder
                }

                // ç›‘å¬é€‰æ‹©å˜åŒ–
                selectElement.onchange = function() {
                    if (this.value) {
                        inputElement.value = this.value;
                        inputElement.placeholder = this.value; // æ›´æ–°placeholderä¸ºé€‰ä¸­çš„æ¨¡å‹
                    } else {
                        inputElement.value = '';
                        inputElement.placeholder = 'é€‰æ‹©æ¨¡å‹...';
                    }
                };

                showNotification(`æˆåŠŸè·å–åˆ° ${models.length} ä¸ªæ¨¡å‹ï¼Œè¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹`, 'success');
            } else {
                // å¦‚æœå·²ç»æ˜¯é€‰æ‹©æ¨¡å¼ï¼Œåˆ‡æ¢å›è¾“å…¥æ¨¡å¼
                selectElement.style.display = 'none';
                inputElement.style.display = 'block';
                // å¦‚æœæ²¡æœ‰å€¼ä¸”placeholderæ˜¯"é€‰æ‹©æ¨¡å‹..."ï¼Œæ¢å¤åŸå§‹placeholder
                if (!inputElement.value && inputElement.placeholder === 'é€‰æ‹©æ¨¡å‹...') {
                    inputElement.placeholder = '{{ current_config.get("openai_model", "gpt-4o") }}';
                }
            }
        } else {
            showNotification('æœªèƒ½è·å–åˆ°æ¨¡å‹åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥Base URLå’ŒAPI Keyé…ç½®', 'warning');
        }

    } catch (error) {
        console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        showNotification('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        fetchButton.classList.remove('loading');
        fetchButton.disabled = false;
        fetchButton.textContent = 'ğŸ“‹';
    }
}

// ä»OpenAI APIè·å–æ¨¡å‹åˆ—è¡¨
async function fetchOpenAIModels(baseUrl, apiKey) {
    try {
        const modelsUrl = `${baseUrl}/models`;

        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        };

        const response = await fetch(modelsUrl, {
            method: 'GET',
            headers: headers
        });

        if (!response.ok) {
            // å°è¯•è§£æé”™è¯¯å“åº”
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            try {
                const errorData = await response.json();
                if (errorData.error) {
                    if (errorData.error.message) {
                        errorMessage = errorData.error.message;
                    } else if (errorData.error.code) {
                        switch (errorData.error.code) {
                            case 'missing_auth_header':
                            case 'invalid_api_key':
                                errorMessage = 'API Keyæ— æ•ˆæˆ–ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥é…ç½®';
                                break;
                            case 'insufficient_quota':
                                errorMessage = 'APIé…é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥è´¦æˆ·ä½™é¢';
                                break;
                            default:
                                errorMessage = `è®¤è¯é”™è¯¯: ${errorData.error.code}`;
                        }
                    }
                }
            } catch (parseError) {
                // å¦‚æœæ— æ³•è§£æé”™è¯¯å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
            }
            throw new Error(errorMessage);
        }

        const data = await response.json();

        if (data.data && Array.isArray(data.data)) {
            // è¿‡æ»¤å¹¶æ’åºæ¨¡å‹åˆ—è¡¨ï¼Œä¼˜å…ˆæ˜¾ç¤ºå¸¸ç”¨çš„èŠå¤©æ¨¡å‹
            const models = data.data
                .filter(model => model.id) // ç¡®ä¿æœ‰ID
                .sort((a, b) => {
                    // ä¼˜å…ˆçº§æ’åºï¼šgpt-4 > gpt-3.5 > å…¶ä»–
                    const getPriority = (id) => {
                        if (id.includes('gpt-4')) return 3;
                        if (id.includes('gpt-3.5')) return 2;
                        return 1;
                    };

                    const priorityA = getPriority(a.id);
                    const priorityB = getPriority(b.id);

                    if (priorityA !== priorityB) {
                        return priorityB - priorityA; // é™åº
                    }

                    return a.id.localeCompare(b.id); // å­—æ¯åº
                });

            return models;
        } else {
            throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°æ¨¡å‹æ•°æ®');
        }

    } catch (error) {
        console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        throw error;
    }
}

// åˆå§‹åŒ–OpenAIæ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
function initOpenAIModelInput() {
    const inputElement = document.getElementById('openai_model_input');
    if (inputElement && !inputElement.value.trim()) {
        inputElement.placeholder = 'é€‰æ‹©æ¨¡å‹...';
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å›¾ç‰‡æœåŠ¡é€‰é¡¹æ˜¾ç¤º
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå®Œå…¨åŠ è½½
    setTimeout(() => {
        toggleImageServiceOptions();
        initOpenAIModelInput();
    }, 100);
});
</script>
{% endblock %}
