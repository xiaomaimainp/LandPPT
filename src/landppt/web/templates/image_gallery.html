{% extends "base.html" %}

{% block title %}æœ¬åœ°å›¾åºŠç®¡ç† - LandPPT{% endblock %}

{% block content %}
<div style="text-align: center; margin-bottom: 40px;">
    <h2 style="color: #2c3e50; margin-bottom: 20px;">ğŸ–¼ï¸ æœ¬åœ°å›¾åºŠç®¡ç†</h2>
    <p style="font-size: 1.1em; color: #7f8c8d;">
        ç®¡ç†å’Œæµè§ˆæ‚¨çš„æœ¬åœ°å›¾ç‰‡åº“ï¼ŒåŒ…æ‹¬AIç”Ÿæˆå›¾ç‰‡ã€æœç´¢å›¾ç‰‡å’Œä¸Šä¼ å›¾ç‰‡
    </p>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯é¢æ¿ -->
<div class="stats-panel" style="margin-bottom: 30px;">
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div class="stat-card">
            <div class="stat-icon">ğŸ¨</div>
            <div class="stat-value" id="ai-generated-count">-</div>
            <div class="stat-label">AIç”Ÿæˆå›¾ç‰‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ”</div>
            <div class="stat-value" id="web-search-count">-</div>
            <div class="stat-label">ç½‘ç»œæœç´¢å›¾ç‰‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-value" id="local-storage-count">-</div>
            <div class="stat-label">æœ¬åœ°ä¸Šä¼ å›¾ç‰‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ’¾</div>
            <div class="stat-value" id="cache-size">-</div>
            <div class="stat-label">ç¼“å­˜å¤§å°</div>
        </div>
    </div>
</div>

<!-- æ“ä½œå·¥å…·æ  -->
<div class="toolbar" style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- åˆ†ç±»ç­›é€‰ -->
            <select id="category-filter" onchange="filterImages()">
                <option value="all">å…¨éƒ¨åˆ†ç±»</option>
                <option value="ai_generated">AIç”Ÿæˆ</option>
                <option value="web_search">ç½‘ç»œæœç´¢</option>
                <option value="local_storage">æœ¬åœ°ä¸Šä¼ </option>
            </select>
            
            <!-- æœç´¢æ¡† -->
            <div style="position: relative;">
                <input type="text" id="search-input" placeholder="æœç´¢å›¾ç‰‡..." 
                       style="padding: 10px 40px 10px 15px; border: 2px solid #e9ecef; border-radius: 8px; width: 250px;"
                       onkeyup="searchImages(event)">
                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #7f8c8d;">ğŸ”</span>
            </div>
            
            <!-- æ’åºé€‰é¡¹ -->
            <select id="sort-option" onchange="sortImages()">
                <option value="created_desc">æœ€æ–°åˆ›å»º</option>
                <option value="created_asc">æœ€æ—©åˆ›å»º</option>
                <option value="accessed_desc">æœ€è¿‘è®¿é—®</option>
                <option value="size_desc">æ–‡ä»¶å¤§å°â†“</option>
                <option value="size_asc">æ–‡ä»¶å¤§å°â†‘</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <!-- ä¸Šä¼ æŒ‰é’® -->
            <button onclick="showUploadModal()" class="btn btn-primary">
                ğŸ“¤ ä¸Šä¼ å›¾ç‰‡
            </button>
            
            <!-- æ‰¹é‡æ“ä½œ -->
            <button onclick="toggleBatchMode()" class="btn btn-info" id="batch-mode-btn">
                â˜‘ï¸ æ‰¹é‡é€‰æ‹©
            </button>
            
            <!-- åˆ·æ–°æŒ‰é’® -->
            <button onclick="refreshGallery()" class="btn btn-success">
                ğŸ”„ åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
<div id="batch-toolbar" class="batch-toolbar" style="display: none; margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <div>
            <span id="selected-count">0</span> å¼ å›¾ç‰‡å·²é€‰æ‹©
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="selectAll()" class="btn btn-info">å…¨é€‰</button>
            <button onclick="clearSelection()" class="btn btn-warning">æ¸…é™¤é€‰æ‹©</button>
            <button onclick="batchDelete()" class="btn btn-danger">åˆ é™¤é€‰ä¸­</button>
            <button onclick="batchDownload()" class="btn btn-success">ä¸‹è½½é€‰ä¸­</button>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡ç½‘æ ¼ -->
<div id="image-grid" class="image-grid">
    <div class="loading-placeholder" style="text-align: center; padding: 60px; color: #7f8c8d;">
        <div style="font-size: 3em; margin-bottom: 20px;">â³</div>
        <p>æ­£åœ¨åŠ è½½å›¾ç‰‡åº“...</p>
    </div>
</div>

<!-- åˆ†é¡µæ§ä»¶ -->
<div id="pagination" class="pagination" style="display: none; margin-top: 30px; text-align: center;">
    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
<div id="upload-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“¤ ä¸Šä¼ å›¾ç‰‡</h3>
            <button onclick="closeUploadModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="upload-area"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
                <div class="upload-content">
                    <div style="font-size: 3em; margin-bottom: 15px; color: #3498db;">ğŸ“</div>
                    <p style="margin-bottom: 15px;">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="file-input" multiple accept="image/*" onchange="handleFileSelect(event)" style="display: none;">
                    <button onclick="document.getElementById('file-input').click()" class="btn btn-primary">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¿¡æ¯è¾“å…¥åŒºåŸŸ -->
            <div id="image-info-section" style="display: none; margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“ å›¾ç‰‡ä¿¡æ¯</h4>

                <div style="margin-bottom: 15px;">
                    <label for="image-title" style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡é¢˜ï¼š</label>
                    <input type="text" id="image-title" placeholder="è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-description" style="display: block; margin-bottom: 5px; font-weight: bold;">æè¿°ï¼š</label>
                    <textarea id="image-description" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°ï¼Œæœ‰åŠ©äºAIæœç´¢åŒ¹é…ï¼ˆæ¨èå¡«å†™ï¼‰"
                              rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-tags" style="display: block; margin-bottom: 5px; font-weight: bold;">æ ‡ç­¾ï¼š</label>
                    <input type="text" id="image-tags" placeholder="è¯·è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼šå•†åŠ¡,å›¾è¡¨,æ•°æ®åˆ†æï¼‰"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666; font-size: 0.9em;">æ ‡ç­¾æœ‰åŠ©äºAIæ™ºèƒ½åŒ¹é…ï¼Œå»ºè®®æ·»åŠ ç›¸å…³å…³é”®è¯</small>
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="image-category" style="display: block; margin-bottom: 5px; font-weight: bold;">åˆ†ç±»ï¼š</label>
                    <select id="image-category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="business">å•†åŠ¡</option>
                        <option value="technology">æŠ€æœ¯</option>
                        <option value="education">æ•™è‚²</option>
                        <option value="design">è®¾è®¡</option>
                        <option value="nature">è‡ªç„¶</option>
                        <option value="people">äººç‰©</option>
                        <option value="abstract">æŠ½è±¡</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div style="text-align: right;">
                    <button onclick="startUpload()" class="btn btn-success" id="start-upload-btn">
                        ğŸš€ å¼€å§‹ä¸Šä¼ 
                    </button>
                </div>
            </div>

            <div id="upload-progress" style="display: none; margin-top: 20px;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p id="upload-status">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>
        </div>
    </div>
</div>

<!-- å›¾ç‰‡è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="image-detail-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="image-detail-title">å›¾ç‰‡è¯¦æƒ…</h3>
            <button onclick="closeImageDetailModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                <div class="image-preview">
                    <img id="detail-image" style="width: 100%; height: auto; border-radius: 8px;">
                </div>
                <div class="image-info">
                    <div class="info-section">
                        <h4>åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="info-item">
                            <label>æ–‡ä»¶å:</label>
                            <span id="detail-filename">-</span>
                        </div>
                        <div class="info-item">
                            <label>å¤§å°:</label>
                            <span id="detail-size">-</span>
                        </div>
                        <div class="info-item">
                            <label>å°ºå¯¸:</label>
                            <span id="detail-dimensions">-</span>
                        </div>
                        <div class="info-item">
                            <label>æ ¼å¼:</label>
                            <span id="detail-format">-</span>
                        </div>
                        <div class="info-item">
                            <label>æ¥æº:</label>
                            <span id="detail-source">-</span>
                        </div>
                        <div class="info-item">
                            <label>åˆ›å»ºæ—¶é—´:</label>
                            <span id="detail-created">-</span>
                        </div>
                        <div class="info-item">
                            <label>è®¿é—®æ¬¡æ•°:</label>
                            <span id="detail-access-count">-</span>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h4>æ“ä½œ</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="downloadImage()" class="btn btn-primary">ä¸‹è½½å›¾ç‰‡</button>
                            <button onclick="copyImageUrl()" class="btn btn-info">å¤åˆ¶é“¾æ¥</button>
                            <button onclick="deleteImage()" class="btn btn-danger">åˆ é™¤å›¾ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let currentImages = [];
let filteredImages = [];
let currentPage = 1;
let itemsPerPage = 20;
let batchMode = false;
let selectedImages = new Set();
let currentImageDetail = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadGalleryStats();
    loadImages();
});

// åŠ è½½å›¾åº“ç»Ÿè®¡ä¿¡æ¯
async function loadGalleryStats() {
    try {
        const response = await fetch('/api/image/gallery/stats');
        const data = await response.json();

        if (data.success) {
            document.getElementById('ai-generated-count').textContent = data.stats.ai_generated || 0;
            document.getElementById('web-search-count').textContent = data.stats.web_search || 0;
            document.getElementById('local-storage-count').textContent = data.stats.local_storage || 0;
            document.getElementById('cache-size').textContent = data.stats.cache_size || '0 MB';
        }
    } catch (error) {
        console.error('Failed to load gallery stats:', error);
    }
}

// åŠ è½½å›¾ç‰‡åˆ—è¡¨
async function loadImages(page = 1) {
    try {
        const category = document.getElementById('category-filter').value;
        const search = document.getElementById('search-input').value;
        const sort = document.getElementById('sort-option').value;

        const params = new URLSearchParams({
            page: page,
            per_page: itemsPerPage,
            category: category === 'all' ? '' : category,
            search: search,
            sort: sort
        });

        const response = await fetch(`/api/image/gallery/list?${params}`);
        const data = await response.json();

        if (data.success) {
            currentImages = data.images;
            filteredImages = currentImages;
            currentPage = page;

            renderImageGrid();
            renderPagination(data.pagination);
        } else {
            showError('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Failed to load images:', error);
        showError('åŠ è½½å›¾ç‰‡å¤±è´¥');
    }
}

// æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
function renderImageGrid() {
    const grid = document.getElementById('image-grid');

    if (filteredImages.length === 0) {
        grid.innerHTML = `
            <div class="loading-placeholder" style="text-align: center; padding: 60px; color: #7f8c8d; grid-column: 1 / -1;">
                <div style="font-size: 3em; margin-bottom: 20px;">ğŸ“·</div>
                <p>æš‚æ— å›¾ç‰‡</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = filteredImages.map(image => `
        <div class="image-item ${selectedImages.has(image.image_id) ? 'selected' : ''}" data-image-id="${image.image_id}">
            ${batchMode ? `<input type="checkbox" class="batch-checkbox" ${selectedImages.has(image.image_id) ? 'checked' : ''} onchange="toggleImageSelection('${image.image_id}')">` : ''}
            <img src="${window.location.origin}/api/image/thumbnail/${image.image_id}"
                 alt="${image.title || image.filename}"
                 class="image-thumbnail"
                 onclick="showImageDetail('${image.image_id}')"
                 onerror="this.src='/static/images/placeholder.svg'">
            <div class="image-info">
                <div class="image-title">${image.title || image.filename}</div>
                <div class="image-meta">
                    <span class="image-source">${getSourceLabel(image.source_type)}</span>
                    <span>${formatFileSize(image.file_size)}</span>
                </div>
                <div class="image-actions">
                    <button onclick="downloadSingleImage('${image.image_id}')" class="btn btn-sm btn-primary">ä¸‹è½½</button>
                    <button onclick="deleteSingleImage('${image.image_id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            </div>
        </div>
    `).join('');
}

// æ¸²æŸ“åˆ†é¡µæ§ä»¶
function renderPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');

    if (pagination.total_pages <= 1) {
        paginationDiv.style.display = 'none';
        return;
    }

    paginationDiv.style.display = 'flex';

    let paginationHTML = '';

    // ä¸Šä¸€é¡µæŒ‰é’®
    paginationHTML += `<button onclick="loadImages(${pagination.current_page - 1})" ${!pagination.has_prev ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;

    // é¡µç æŒ‰é’®
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);

    if (startPage > 1) {
        paginationHTML += `<button onclick="loadImages(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span>...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<button onclick="loadImages(${i})" ${i === pagination.current_page ? 'class="active"' : ''}>${i}</button>`;
    }

    if (endPage < pagination.total_pages) {
        if (endPage < pagination.total_pages - 1) {
            paginationHTML += `<span>...</span>`;
        }
        paginationHTML += `<button onclick="loadImages(${pagination.total_pages})">${pagination.total_pages}</button>`;
    }

    // ä¸‹ä¸€é¡µæŒ‰é’®
    paginationHTML += `<button onclick="loadImages(${pagination.current_page + 1})" ${!pagination.has_next ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

    paginationDiv.innerHTML = paginationHTML;
}

// ç­›é€‰å›¾ç‰‡
function filterImages() {
    loadImages(1);
}

// æœç´¢å›¾ç‰‡
function searchImages(event) {
    if (event.key === 'Enter' || event.type === 'input') {
        loadImages(1);
    }
}

// æ’åºå›¾ç‰‡
function sortImages() {
    loadImages(1);
}

// åˆ·æ–°å›¾åº“
function refreshGallery() {
    loadGalleryStats();
    loadImages(currentPage);
}

// è·å–æ¥æºæ ‡ç­¾
function getSourceLabel(sourceType) {
    const labels = {
        'ai_generated': 'AIç”Ÿæˆ',
        'web_search': 'ç½‘ç»œæœç´¢',
        'local_storage': 'æœ¬åœ°ä¸Šä¼ '
    };
    return labels[sourceType] || sourceType;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿ
    alert(message);
}

// æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
function showSuccess(message) {
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„é€šçŸ¥ç³»ç»Ÿ
    alert(message);
}

// æ‰¹é‡é€‰æ‹©ç›¸å…³åŠŸèƒ½
function toggleBatchMode() {
    batchMode = !batchMode;
    const btn = document.getElementById('batch-mode-btn');
    const toolbar = document.getElementById('batch-toolbar');

    if (batchMode) {
        btn.textContent = 'âŒ é€€å‡ºæ‰¹é‡';
        btn.className = 'btn btn-warning';
        toolbar.style.display = 'block';
    } else {
        btn.textContent = 'â˜‘ï¸ æ‰¹é‡é€‰æ‹©';
        btn.className = 'btn btn-info';
        toolbar.style.display = 'none';
        selectedImages.clear();
    }

    renderImageGrid();
    updateSelectedCount();
}

function toggleImageSelection(imageId) {
    if (selectedImages.has(imageId)) {
        selectedImages.delete(imageId);
    } else {
        selectedImages.add(imageId);
    }

    renderImageGrid();
    updateSelectedCount();
}

function selectAll() {
    filteredImages.forEach(image => selectedImages.add(image.image_id));
    renderImageGrid();
    updateSelectedCount();
}

function clearSelection() {
    selectedImages.clear();
    renderImageGrid();
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedImages.size;
}

// æ‰¹é‡åˆ é™¤
async function batchDelete() {
    if (selectedImages.size === 0) {
        showError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡');
        return;
    }

    if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedImages.size} å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
        return;
    }

    try {
        const response = await fetch('/api/image/gallery/batch-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_ids: Array.from(selectedImages)
            })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(`æˆåŠŸåˆ é™¤ ${data.deleted_count} å¼ å›¾ç‰‡`);
            selectedImages.clear();
            refreshGallery();
        } else {
            showError('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Batch delete failed:', error);
        showError('æ‰¹é‡åˆ é™¤å¤±è´¥');
    }
}

// æ‰¹é‡ä¸‹è½½
async function batchDownload() {
    if (selectedImages.size === 0) {
        showError('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡');
        return;
    }

    try {
        const response = await fetch('/api/image/gallery/batch-download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image_ids: Array.from(selectedImages)
            })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `images_${new Date().getTime()}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showSuccess(`æˆåŠŸä¸‹è½½ ${selectedImages.size} å¼ å›¾ç‰‡`);
        } else {
            showError('æ‰¹é‡ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('Batch download failed:', error);
        showError('æ‰¹é‡ä¸‹è½½å¤±è´¥');
    }
}

// å•å¼ å›¾ç‰‡æ“ä½œ
async function downloadSingleImage(imageId) {
    try {
        const response = await fetch(`/api/image/download/${imageId}`);

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // ä»å“åº”å¤´è·å–æ–‡ä»¶å
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'image';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            showError('ä¸‹è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('Download failed:', error);
        showError('ä¸‹è½½å¤±è´¥');
    }
}

async function deleteSingleImage(imageId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }

    try {
        const response = await fetch(`/api/image/delete/${imageId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('å›¾ç‰‡åˆ é™¤æˆåŠŸ');
            refreshGallery();
        } else {
            showError('åˆ é™¤å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Delete failed:', error);
        showError('åˆ é™¤å¤±è´¥');
    }
}

// ä¸Šä¼ ç›¸å…³åŠŸèƒ½
function showUploadModal() {
    document.getElementById('upload-modal').style.display = 'flex';
}

function closeUploadModal() {
    document.getElementById('upload-modal').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('image-info-section').style.display = 'none';
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('file-input').value = '';

    // é‡ç½®è¾“å…¥å­—æ®µ
    document.getElementById('image-title').value = '';
    document.getElementById('image-description').value = '';
    document.getElementById('image-tags').value = '';
    document.getElementById('image-category').value = 'business';

    // æ¸…ç©ºé€‰ä¸­çš„æ–‡ä»¶
    selectedFiles = [];
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');

    const files = event.dataTransfer.files;
    handleFiles(files);
}

function handleFileSelect(event) {
    const files = event.target.files;
    handleFiles(files);
}

let selectedFiles = [];

function handleFiles(files) {
    if (files.length === 0) return;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    const validFiles = Array.from(files).filter(file => validTypes.includes(file.type));

    if (validFiles.length === 0) {
        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (JPG, PNG, WebP, GIF)');
        return;
    }

    if (validFiles.length !== files.length) {
        showError(`å·²è¿‡æ»¤æ‰ ${files.length - validFiles.length} ä¸ªæ— æ•ˆæ–‡ä»¶`);
    }

    selectedFiles = validFiles;

    // æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯è¾“å…¥åŒºåŸŸ
    document.getElementById('image-info-section').style.display = 'block';

    // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨å¡«å…¥æ–‡ä»¶åä½œä¸ºæ ‡é¢˜
    if (validFiles.length === 1) {
        document.getElementById('image-title').value = validFiles[0].name.split('.')[0];
    } else {
        document.getElementById('image-title').placeholder = `æ‰¹é‡ä¸Šä¼  ${validFiles.length} ä¸ªæ–‡ä»¶`;
    }
}

async function startUpload() {
    if (selectedFiles.length === 0) {
        showError('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }

    // è·å–ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯
    const title = document.getElementById('image-title').value.trim();
    const description = document.getElementById('image-description').value.trim();
    const tags = document.getElementById('image-tags').value.trim();
    const category = document.getElementById('image-category').value;

    // éšè—ä¿¡æ¯è¾“å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
    document.getElementById('image-info-section').style.display = 'none';
    document.getElementById('upload-progress').style.display = 'block';

    let uploadedCount = 0;
    const totalFiles = selectedFiles.length;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];

        try {
            document.getElementById('upload-status').textContent = `æ­£åœ¨ä¸Šä¼  ${file.name} (${i + 1}/${totalFiles})`;

            const formData = new FormData();
            formData.append('file', file);

            // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
            const fileTitle = title || file.name.split('.')[0];
            formData.append('title', fileTitle);
            formData.append('description', description);
            formData.append('tags', tags);
            formData.append('category', category);

            const response = await fetch('/api/image/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                uploadedCount++;
            } else {
                console.error(`Upload failed for ${file.name}:`, data.message);
            }

            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((i + 1) / totalFiles) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

        } catch (error) {
            console.error(`Upload error for ${file.name}:`, error);
        }
    }

    // ä¸Šä¼ å®Œæˆ
    document.getElementById('upload-status').textContent = `ä¸Šä¼ å®Œæˆï¼æˆåŠŸä¸Šä¼  ${uploadedCount}/${totalFiles} ä¸ªæ–‡ä»¶`;

    if (uploadedCount > 0) {
        setTimeout(() => {
            closeUploadModal();
            refreshGallery();
            showSuccess(`æˆåŠŸä¸Šä¼  ${uploadedCount} å¼ å›¾ç‰‡`);
        }, 2000);
    }
}

// å›¾ç‰‡è¯¦æƒ…ç›¸å…³åŠŸèƒ½
async function showImageDetail(imageId) {
    try {
        const response = await fetch(`/api/image/detail/${imageId}`);
        const data = await response.json();

        if (data.success) {
            currentImageDetail = data.image;

            // å¡«å……è¯¦æƒ…ä¿¡æ¯
            document.getElementById('image-detail-title').textContent = data.image.title || data.image.filename;
            document.getElementById('detail-image').src = `${window.location.origin}/api/image/view/${imageId}`;
            document.getElementById('detail-filename').textContent = data.image.filename;
            document.getElementById('detail-size').textContent = formatFileSize(data.image.file_size);
            document.getElementById('detail-dimensions').textContent = `${data.image.width} Ã— ${data.image.height}`;
            document.getElementById('detail-format').textContent = data.image.format.toUpperCase();
            document.getElementById('detail-source').textContent = getSourceLabel(data.image.source_type);
            document.getElementById('detail-created').textContent = new Date(data.image.created_at * 1000).toLocaleString();
            document.getElementById('detail-access-count').textContent = data.image.access_count || 0;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('image-detail-modal').style.display = 'flex';
        } else {
            showError('è·å–å›¾ç‰‡è¯¦æƒ…å¤±è´¥: ' + data.message);
        }
    } catch (error) {
        console.error('Failed to load image detail:', error);
        showError('è·å–å›¾ç‰‡è¯¦æƒ…å¤±è´¥');
    }
}

function closeImageDetailModal() {
    document.getElementById('image-detail-modal').style.display = 'none';
    currentImageDetail = null;
}

async function downloadImage() {
    if (!currentImageDetail) return;
    await downloadSingleImage(currentImageDetail.image_id);
}

async function copyImageUrl() {
    if (!currentImageDetail) return;

    const url = `${window.location.origin}/api/image/view/${currentImageDetail.image_id}`;

    try {
        await navigator.clipboard.writeText(url);
        showSuccess('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    } catch (error) {
        // é™çº§æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccess('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
}

async function deleteImage() {
    if (!currentImageDetail) return;

    await deleteSingleImage(currentImageDetail.image_id);
    closeImageDetailModal();
}

// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(event) {
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    if (event.key === 'Escape') {
        if (document.getElementById('upload-modal').style.display === 'flex') {
            closeUploadModal();
        }
        if (document.getElementById('image-detail-modal').style.display === 'flex') {
            closeImageDetailModal();
        }
    }

    // Ctrl+A å…¨é€‰ï¼ˆåœ¨æ‰¹é‡æ¨¡å¼ä¸‹ï¼‰
    if (event.ctrlKey && event.key === 'a' && batchMode) {
        event.preventDefault();
        selectAll();
    }

    // Deleteé”®åˆ é™¤é€‰ä¸­é¡¹
    if (event.key === 'Delete' && batchMode && selectedImages.size > 0) {
        batchDelete();
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.stat-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
}

.stat-value {
    font-size: 2em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 5px;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9em;
}

/* å›¾ç‰‡ç½‘æ ¼æ ·å¼ */
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.image-item {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

.image-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
}

.image-item.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
}

.image-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    cursor: pointer;
}

.image-info {
    padding: 15px;
}

.image-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-primary);
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.image-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.image-source {
    background: var(--primary-color);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7em;
}

.image-actions {
    display: flex;
    gap: 5px;
    justify-content: center;
}

.image-actions button {
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.3s ease;
}

/* æ‰¹é‡é€‰æ‹©å¤é€‰æ¡† */
.batch-checkbox {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 20px;
    height: 20px;
    z-index: 10;
}

/* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
.upload-area {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.1);
}

/* è¿›åº¦æ¡æ ·å¼ */
.progress-bar {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: var(--primary-gradient);
    width: 0%;
    transition: width 0.3s ease;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 15px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.modal-body {
    padding: 20px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: #999;
}

.close-btn:hover {
    color: #333;
}

/* ä¿¡æ¯é¡¹æ ·å¼ */
.info-section {
    margin-bottom: 20px;
}

.info-section h4 {
    margin-bottom: 10px;
    color: var(--primary-color);
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-item label {
    font-weight: 600;
    color: var(--text-secondary);
}

/* åˆ†é¡µæ ·å¼ */
.pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.pagination button {
    padding: 8px 12px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination button:hover {
    background: var(--primary-color);
    color: white;
}

.pagination button.active {
    background: var(--primary-color);
    color: white;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
}
</style>
{% endblock %}
