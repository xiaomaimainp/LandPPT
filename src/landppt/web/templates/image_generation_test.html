{% extends "base.html" %}

{% block title %}å›¾ç‰‡ç”Ÿæˆæµ‹è¯•{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">ğŸ¨ AIå›¾ç‰‡ç”Ÿæˆæµ‹è¯•</h2>
    
    <!-- æä¾›è€…çŠ¶æ€ -->
    <div id="provider-status" style="margin-bottom: 30px;">
        <h3>æä¾›è€…çŠ¶æ€</h3>
        <div id="status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <!-- çŠ¶æ€å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- å›¾ç‰‡ç”Ÿæˆè¡¨å• -->
    <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px;">ç”Ÿæˆå›¾ç‰‡</h3>
        
        <form id="generation-form">
            <!-- æç¤ºè¯è¾“å…¥ -->
            <div style="margin-bottom: 20px;">
                <label for="prompt" style="display: block; margin-bottom: 8px; font-weight: bold;">æç¤ºè¯ï¼š</label>
                <textarea id="prompt" name="prompt" rows="3" 
                         style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;"
                         placeholder="æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡..."></textarea>
            </div>
            
            <!-- æä¾›è€…é€‰æ‹© -->
            <div style="margin-bottom: 20px;">
                <label for="provider" style="display: block; margin-bottom: 8px; font-weight: bold;">AIæä¾›è€…ï¼š</label>
                <select id="provider" name="provider" 
                        style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                    <option value="">é€‰æ‹©æä¾›è€…...</option>
                    <option value="dalle">DALL-E</option>
                    <option value="stable_diffusion">Stable Diffusion</option>
                    <option value="siliconflow">SiliconFlow (Kolors)</option>
                </select>
            </div>
            
            <!-- å°ºå¯¸é€‰æ‹© -->
            <div style="margin-bottom: 20px;">
                <label for="size" style="display: block; margin-bottom: 8px; font-weight: bold;">å›¾ç‰‡å°ºå¯¸ï¼š</label>
                <select id="size" name="size" 
                        style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px;">
                    <option value="1024x1024">1024x1024 (æ­£æ–¹å½¢)</option>
                    <option value="1792x1024">1792x1024 (16:9æ¨ªå‘)</option>
                    <option value="1024x1792">1024x1792 (9:16ç«–å‘)</option>
                </select>
            </div>
            
            <!-- ç”ŸæˆæŒ‰é’® -->
            <button type="submit" id="generate-btn"
                    style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; border: none; padding: 15px; border-radius: 8px; 
                           font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                ğŸ¨ ç”Ÿæˆå›¾ç‰‡
            </button>
        </form>
    </div>
    
    <!-- ç”Ÿæˆè¿›åº¦ -->
    <div id="generation-progress" style="display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <div style="text-align: center;">
            <div style="font-size: 2em; margin-bottom: 15px;">â³</div>
            <div id="progress-text">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>
            <div style="width: 100%; background: #f0f0f0; border-radius: 10px; margin-top: 15px; overflow: hidden;">
                <div id="progress-bar" style="width: 0%; height: 8px; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>
    
    <!-- ç”Ÿæˆç»“æœ -->
    <div id="generation-result" style="display: none; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 20px;">ç”Ÿæˆç»“æœ</h3>
        <div id="result-content">
            <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<script>
// é¡µé¢åŠ è½½æ—¶è·å–æä¾›è€…çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    loadProviderStatus();
});

// åŠ è½½æä¾›è€…çŠ¶æ€
async function loadProviderStatus() {
    try {
        const response = await fetch('/api/image/status');
        const data = await response.json();
        
        const statusCards = document.getElementById('status-cards');
        statusCards.innerHTML = '';
        
        // åˆ›å»ºçŠ¶æ€å¡ç‰‡
        const providers = [
            { key: 'dalle', name: 'DALL-E', icon: 'ğŸ¨' },
            { key: 'stable_diffusion', name: 'Stable Diffusion', icon: 'ğŸ–¼ï¸' },
            { key: 'siliconflow', name: 'SiliconFlow', icon: 'âš¡' }
        ];
        
        providers.forEach(provider => {
            const isAvailable = data.available_providers.includes(provider.key);
            const card = document.createElement('div');
            card.style.cssText = `
                background: ${isAvailable ? '#d4edda' : '#f8d7da'};
                border: 2px solid ${isAvailable ? '#c3e6cb' : '#f5c6cb'};
                border-radius: 8px;
                padding: 15px;
                text-align: center;
            `;
            
            card.innerHTML = `
                <div style="font-size: 2em; margin-bottom: 10px;">${provider.icon}</div>
                <div style="font-weight: bold; margin-bottom: 5px;">${provider.name}</div>
                <div style="color: ${isAvailable ? '#155724' : '#721c24'}; font-size: 0.9em;">
                    ${isAvailable ? 'âœ… å¯ç”¨' : 'âŒ æœªé…ç½®'}
                </div>
            `;
            
            statusCards.appendChild(card);
        });
        
    } catch (error) {
        console.error('Failed to load provider status:', error);
    }
}

// å¤„ç†è¡¨å•æäº¤
document.getElementById('generation-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const prompt = formData.get('prompt');
    const provider = formData.get('provider');
    const size = formData.get('size');
    
    if (!prompt.trim()) {
        alert('è¯·è¾“å…¥æç¤ºè¯');
        return;
    }
    
    if (!provider) {
        alert('è¯·é€‰æ‹©AIæä¾›è€…');
        return;
    }
    
    // æ˜¾ç¤ºè¿›åº¦
    showProgress();
    
    try {
        const response = await fetch('/api/image/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: prompt,
                provider: provider,
                size: size
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showResult(data, prompt, provider);
        } else {
            showError(data.message || 'ç”Ÿæˆå¤±è´¥');
        }
        
    } catch (error) {
        console.error('Generation failed:', error);
        showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
    } finally {
        hideProgress();
    }
});

// æ˜¾ç¤ºè¿›åº¦
function showProgress() {
    document.getElementById('generation-progress').style.display = 'block';
    document.getElementById('generation-result').style.display = 'none';
    document.getElementById('generate-btn').disabled = true;
    document.getElementById('generate-btn').textContent = 'ç”Ÿæˆä¸­...';
    
    // æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 500);
    
    // å­˜å‚¨intervalä»¥ä¾¿åç»­æ¸…ç†
    window.progressInterval = interval;
}

// éšè—è¿›åº¦
function hideProgress() {
    document.getElementById('generation-progress').style.display = 'none';
    document.getElementById('generate-btn').disabled = false;
    document.getElementById('generate-btn').textContent = 'ğŸ¨ ç”Ÿæˆå›¾ç‰‡';
    
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
}

// æ˜¾ç¤ºç»“æœ
function showResult(data, prompt, provider) {
    const resultDiv = document.getElementById('generation-result');
    const resultContent = document.getElementById('result-content');
    
    resultContent.innerHTML = `
        <div style="margin-bottom: 20px;">
            <strong>æç¤ºè¯ï¼š</strong> ${prompt}<br>
            <strong>æä¾›è€…ï¼š</strong> ${provider}<br>
            <strong>çŠ¶æ€ï¼š</strong> <span style="color: #28a745;">âœ… ç”ŸæˆæˆåŠŸ</span>
        </div>
        <div style="text-align: center;">
            <img src="${data.image_path}" alt="Generated Image" 
                 style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <a href="${data.image_path}" download style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                ğŸ“¥ ä¸‹è½½å›¾ç‰‡
            </a>
        </div>
    `;
    
    resultDiv.style.display = 'block';
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    const resultDiv = document.getElementById('generation-result');
    const resultContent = document.getElementById('result-content');
    
    resultContent.innerHTML = `
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; text-align: center;">
            <strong>âŒ ç”Ÿæˆå¤±è´¥</strong><br>
            ${message}
        </div>
    `;
    
    resultDiv.style.display = 'block';
}
</script>
{% endblock %}
